### SET协议实现电子交易  


双重签名
 
<img src="../pictures/xwy8z2u2fpq.png" width="600px" />
双重签名的作用  
对于持卡人来说：持卡人完成一次电子交易需要向商家列出购买的商品清单和支付凭证,而商家只能验证该支付凭证不能读取  
对于商家而言：双重签名的目的是将每一次电子交易涉及的支付信息和订货信息绑定,并证明这两组信息确实由持卡人给出。其中PI指的是支付信息，OI指的是订货信息
商家获得支付PIMD,再加上订货信息算出双重数字签名来验证  

支付网关获得OIMD,再加上支付信息算出双重数字签名来验证的

下面来讲一下电子交易过程，我们所谓的电子交易过程是持卡人在收到商家返回的订货信息后开始的  
<img src="../pictures/m1dzoc4o16o.png" width="600px" />
1. 初始请求消息,包含持卡人拥有的信用卡类型、发卡机构请求标识和随机数(发送端封装),发送信用卡类型
2. 商家进行签名鉴别和数据完整性检测,再向持卡人发送初始响应消息:包括这次交易分配的交易标识符、商家和支付网关证书,以及匹配的请求标识和随机数。(认证+发送端封装），商家从请求报文中获取到行用卡类型，找到
3.  持卡人获得购物清单、本次交易金额、本次交易标识符、商家和支付网关证书后,构建支付信息和订货信息捆绑,封装购买请求消息。(双重签名+购买请求消息封装)
4. 商家鉴别购买请求消息,再处理订单,并向支付网关发送授权请求消息,以此来确认持卡人账户的有效性(鉴别+授权请求消息封装)
5. 支付网关验证授权请求消息,并向商家发送授权响应消息(认证+授权响应消息封装)
6. 商家保留支付信息密文,并向持卡人发送购货响应消息(发送端封装)  
7. 商家提供本次交易要求的货物和服务后,向支付网关发送支付请求消息。(支付请求消息封装)  
8. 支付网关验证支付请求消息,完成支付,并向商家发送支付响应消  

第一点与第二点可以看成客户使用哪家银行进行支付，商家就返回这家银行的支付网关和交易凭证。  
第三点可以看成客户接收到支付网关和交易凭证后就提交支付信息和订单信息   
第四点、第五点可以看成验证订单信息没问题的话，就向银行请求交易凭证是否可行（账户里面有没有钱？）  


#### 封装发送信息
##### 持卡人封装发送信息


<img src="../pictures/s0mvm0nemt.png" width="600px" />  

![](../pictures/vhuc1mnxorn.png)  

其中SKC是发送者的私钥，H是报文摘要算法。PKA是商家的公钥.双方会话密钥通过PKA加密后生成数字封面  

#### 商家认证发送者身份和解密数据过程

##### 商家解密数据过程  
<img src="../pictures/8xidr2osmpk.png" width="500px" />  


##### 商家封装发送信息   

<img src="../pictures/rgoinn328zn.png" width="600px" />  


其中SKA指的是商家的私钥，PKC指的是持卡人的公钥。在这里我们需要使用公钥来解密数字签名，从而获取到信息.

#### 购买请求消息封装过程  

<img src="../pictures/kxdapvdhpcr.png" width="200px" />  

PKA是商家的公钥，PKG指的是支付网关的公钥。最终生成的购买请求消息由持卡人发给商家，而购买请求中关于支付网关的部分将由商家转发给支付网关  

#### 商家鉴别购买请求消息和发送请求到支付网关
##### 商家鉴别购买请求消息  

<img src="../pictures/gsjal1muk0l.png" width="600px" />  

#####  发送请求到支付网关  

<img src="../pictures/atswv2yanit.png" width="400px" />  

PKG指的是支付网关的公钥,SKA指的是商家的私钥
 


#### 支付网关验证授权请求消息  

<img src="../pictures/c84pu2bxc46.png" width="400px" />  


#### 商家请求支付请求消息  

<img src="../pictures/2gp2py46yzh.png" width="400px" />